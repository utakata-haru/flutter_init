# アプリケーション仕様書（テンプレート）

> このファイルは第一段階（仕様策定）で更新する、仕様書の雛形です。各項目を埋めていき、合意形成後に最新版として維持します。

## メタ情報
- プロジェクト名: TBD（要確認）
- バージョン: 0.1.0-draft
- 最終更新日: 2025-11-13
- 作成者: GitHub Copilot（App_Builder）

## 概要
- コンセプト: ITサービスのステータスページのように、日々のルーチン達成状況を一目で判定する時間管理サポートアプリ
- 目的（解決したい課題）: 毎日のルーチンを設定した目標時刻どおりに実行できたかを簡単に把握し、時間管理が苦手な人でも継続しやすい仕組みを提供する
- 背景・文脈: ToDoアプリ的なシンプルさを保ちつつ、目標時間との差分を色とアイコンでフィードバックしてモチベーション維持を促す

## ターゲットユーザー・ペルソナ
- 主要ペルソナ: 時間管理が苦手な人（特にADHD傾向のある社会人・学生）
- ユーザー課題: ルーチンの開始・終了時刻が守れず、毎回自分で振り返る手間や達成状況の把握が難しい
- 利用シナリオ: 朝の支度や就寝前のルーチンを登録し、完了時にボタンを押して達成状況をステータス表示で確認する

## ユースケース一覧
- UC-01: ルーチンを新規登録・編集し、目標時刻や許容ズレ時間を設定する
- UC-02: ルーチン実行後に完了ボタンを押し、実績時刻を記録する
- UC-03: トップ画面で各ルーチンの達成ステータス（オンタイム／注意／警告）を確認する

## スコープ定義
- In-Scope（今回対象）: ルーチン登録・一覧表示・完了登録・ステータス判定UI、オンタイム判定閾値の個別設定、基本的な設定画面
- Out-of-Scope（今回対象外）: ソーシャル共有、通知・アラーム連携、詳細レポートや長期的な統計分析、管理者が複数ユーザーの状況を一括監視する機能（将来検討）

## 機能要件（機能定義）
- ルーチン管理
  - 説明: ルーチン名・目標時刻・許容ズレ時間を登録／編集／削除できる
  - 受け入れ基準: 必須項目のバリデーションを通過した入力で保存でき、一覧に即時反映される
  - 依存関係: 永続化（ストレージ）
- ルーチン完了記録
  - 説明: 完了ボタンを押すことで実績時刻を記録する
  - 受け入れ基準: ボタン押下時の時刻が保存され、判定ロジックが動作する。完了済みの場合は「完了を取り消す」操作で直近記録をクリアできる
  - 依存関係: ルーチン管理
- ルーチン追加UI
  - 説明: 起床・出勤などの日常ルーチンを名称と目標時刻で登録できるフォームを提供し、ダッシュボードから即時追加できる
  - 受け入れ基準: ルーチン名必須、目標時刻選択、保存後に一覧へ自動反映され成否通知が表示される
  - 依存関係: ルーチン管理、アプリケーション層状態管理
- ステータス判定・表示
  - 説明: 目標時刻との比較でオンタイム（緑チェック）、軽微遅延（黄エクスクラメーション）、大幅遅延（赤バツ）を判定しトップ画面に表示
  - 受け入れ基準: 設定した許容ズレ時間内で緑、それを超えるが大幅閾値未満で黄、大幅閾値以上で赤となる（大幅閾値は暫定TBD）
  - 依存関係: ルーチン完了記録、設定管理
- 設定管理
  - 説明: オンタイム判定の閾値（例: 5分以内で緑、15分以内で黄など）をユーザーが設定画面で調整できる
  - 受け入れ基準: 設定値を保存し、以降の判定ロジックに反映される
  - 依存関係: ルーチン管理
- アプリケーション層状態管理
  - 説明: Riverpod Notifier を通じてダッシュボード／設定画面の状態を監視し、ルーチン一覧や閾値ストリームの更新を自動反映する
  - 受け入れ基準: Watch するだけで最新状態が取得でき、完了／保存操作後はストリーム経由でリストと閾値が即時更新される
  - 依存関係: ルーチン管理、設定管理、リポジトリ層
- ダッシュボードUI
  - 説明: ルーチン一覧をステータスカード形式で表示し、閾値サマリー・完了ボタン・削除操作・プルリフレッシュに対応する
  - 受け入れ基準: ルーチンが0件の場合は空表示を出し、エラー時はスナックバーで通知、設定画面への遷移アイコンを提供する。未完了のルーチンは中立アイコンで表示し、達成履歴がある場合のみステータスアイコンを表示する。完了済みのカードには「完了を取り消す」ボタンを表示し、未完了には「完了として記録」ボタンを出し分ける。ヘッダーには最新の完了状況を集約したステータスカードを表示し、オンタイム／遅延／乱れの3段階を緑・黄・赤の背景と専用アイコンで色分けする（ITサービスのステータスページ風）。ヘルプアイコンからステータス説明ページへ遷移できる。画面下部のクイック完了ボタンで次に完了すべきルーチンを一括登録できる
  - 依存関係: アプリケーション層状態管理、ステータス表示コンポーネント
- ヘルプページ
  - 説明: ステータスカードや各アイコンの意味、現在設定されている閾値を参照できる説明画面
  - 受け入れ基準: ダッシュボードのヘルプアイコンから遷移でき、オンタイム／遅延／乱れの表示ルールと閾値（分単位）が現在値に基づき表示される。閾値取得に失敗した場合は再試行導線を提示する
  - 依存関係: アプリケーション層状態管理、設定管理
- 閾値設定UI
  - 説明: 閾値（オンタイム／警告）をフォーム入力で編集し、保存成功・失敗をスナックバーで通知する設定ページ
  - 受け入れ基準: 数値バリデーション（0以上、警告 >= オンタイム）を行い、保存操作中はボタンを無効化しローディングインジケーターを表示する
  - 依存関係: アプリケーション層状態管理、設定管理

## 画面設計（概要）
- 主要画面: トップ（ステータス一覧）、ルーチン編集モーダル（ルーチン追加）、閾値設定ページ、ステータス説明ページ
- 画面遷移（テキスト／図示可）: トップ（/routine） → ルーチン追加ボトムシート、トップ（/routine） → 設定（/routine/settings）
- ナビゲーション原則: シンプルな下部またはトップメニューは持たず、トップ画面からモーダルやページ遷移で操作する

- エンティティ定義（名称／属性／型／制約）: ルーチン（id、name、targetTime、allowableDelayMinutes、criticalDelayMinutes?、status、lastCompletedAt）
- バリデーション要件: ルーチン名必須、目標時刻必須、許容ズレ時間は0以上、criticalDelayMinutesはallowableDelayMinutes以上
- 永続化・保存戦略: Drift（ローカルDB）で端末内に保存し、完了履歴・閾値設定を同一DBで管理。`RoutineModel` や `RoutineSettingsModel` を介してドメインエンティティとDriftデータを変換し、JSONシリアライズにも対応してデバッグ／バックアップ用途を想定。ローカルデータソース層（RoutineLocalDataSource／RoutineSettingsLocalDataSource）がCRUDと監視ストリームを提供し、例外を集約する

## 非機能要件
- 性能（応答時間／安定性）: 操作からフィードバックまで1秒未満、オフラインでも即時操作可能
- セキュリティ（認可・認証・データ保護）: 当面ユーザーアカウントなし、端末内データの保護を前提
- 可用性・運用: 単一端末利用を想定、同期機能は範囲外
- アクセシビリティ: 視覚的ステータス差が明確になる配色とアイコンの併用

- 参照ドキュメント: `AI/architecture/technology_stack.md`
- 採用技術（言語／フレームワーク／主要ライブラリ）: Flutter（Dart）、状態管理にRiverpod、ローカルDBにDrift、画面遷移にGoRouter、データモデルにFreezed

## リスク・前提・制約
- 主要リスク: 設定可能な閾値の理解負荷が高まる可能性、ローカルストレージ選定による実装コスト
- 重要前提: マルチデバイス同期や通知は初期リリース対象外、想定ユーザー数は少人数（家族・チーム単位）でスケール対応は後続検討
- 制約条件: UIはステータスサイト風の緑／黄／赤を基調にしたデザイン

- 外部API／サービス: 現時点なし
- ライブラリ／プラグイン: Riverpod、hooks_riverpod、flutter_hooks、Drift、sqlite3、sqlite3_flutter_libs、Freezed、GoRouter、path_provider、json_annotation（および開発向け `json_serializable`）

## マイルストーン（仕様策定観点）
- M1: 仕様草案提示（2025-11-12 目標）
- M2: 詳細化・合意（2025-11-14 目標）
- M3: 第二段階へ移行（仕様合意後に構造計画へ移行）

## 受け入れ基準（全体）
- 合意文言: 「仕様内容に合意し、構造計画へ進む」
- 必要ドキュメント: 本仕様書最新版、補助資料（必要に応じて）
  - 備考: 大幅遅延閾値（criticalDelayMinutes）の初期値は後続検討

## 更新履歴
- 2025-11-10: テンプレート初期値入力
- 2025-11-10: 仕様草案初稿（コンセプト／要件追記）
- 2025-11-11: 仕様草案合意（第二段階へ移行）
- 2025-11-11: 永続化の詳細を追記（RoutineModelによるDriftマッピングを補足）
- 2025-11-11: パッケージ一覧に path_provider を追加
- 2025-11-11: JSONシリアライズ対応のため json_annotation / json_serializable を追加
- 2025-11-11: RoutineModel が JSON シリアライズに対応することを仕様に明記
- 2025-11-11: RoutineSettingsModel の実装と役割を永続化方針に追記
- 2025-11-11: ローカルデータソース層の責務（Drift操作・例外集約）を追記
- 2025-11-12: Riverpod を用いたダッシュボード／設定 Notifier と状態クラスの追加を仕様に反映
- 2025-11-12: ダッシュボード／閾値設定ページのUI要件とルーティング仕様を追記
- 2025-11-12: Riverpodリスナーの初期化順序を調整し、循環参照エラーを防止
- 2025-11-12: 閾値設定ページ初期表示時に自動で最新データを取得する挙動を追記
- 2025-11-13: ルーチン追加フォームと即時反映要件、登録時の通知仕様を追記
- 2025-11-13: 未完了ルーチンの表示アイコンを中立にするUI仕様を反映
- 2025-11-13: クイック完了ボタンで先頭ルーチンを完了する仕様を追記
- 2025-11-13: 完了済みルーチンで「完了を取り消す」ボタンを表示する仕様を追記
- 2025-11-13: 全体状態の表示カードを緑／黄／赤の背景とアイコンで案内する仕様を追記
- 2025-11-13: 最新完了状況に応じて全体ステータスカードの色と文言を自動切り替えする仕様を追記
- 2025-11-13: ステータス説明ページとヘルプアイコン遷移を仕様に追加

## 参考・関連
- プロセス詳細（第一段階）:
  - `AI/instructions/new_app/001/project_rules_stage1_step1.md`
  - `AI/instructions/new_app/001/project_rules_stage1_step2.md`
  - `AI/instructions/new_app/001/project_rules_stage1_step3.md`
  - `AI/instructions/new_app/001/project_rules_stage1_step4.md`
- 上位方針: `AI/instructions/project_rules.md`
- アーキテクチャ規約: `AI/architecture/lib/features/features_architecture.md`